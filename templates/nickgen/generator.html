<!-- templates/nickgen/generator.html -->
{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h1 class="h3 mb-3">닉네임 생성기</h1>
  <form method="get" class="row g-2 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label">모드</label>
      {{ form.mode }}
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">언어</label>
      {{ form.lang }}
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">스타일(Combo 전용)</label>
      {{ form.style }}
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">시드(선택)</label>
      {{ form.seed }}
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">개수</label>
      {{ form.count }}
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">최소 길이</label>
      {{ form.min_len }}
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">최대 길이</label>
      {{ form.max_len }}
    </div>

    <div class="col-6 col-md-3">
  <div class="form-check mt-4">
    {{ form.allow_number_tail }}
    <label class="form-check-label" for="{{ form.allow_number_tail.id_for_label }}">숫자 꼬리 허용</label>
  </div>
</div>

    <div class="col-12 col-md-3 mt-3 mt-md-0">
      <button class="btn btn-success w-100" style="background:#00d084;border-color:#00d084;">생성하기</button>
    </div>
  </form>

  {% if results %}
  <hr class="my-4" />
  <div class="row row-cols-1 row-cols-md-3 g-3" id="results">
    {% for r in results %}
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <span class="fw-bold">{{ r }}</span>
          <div class="btn-group">
            {% if request.user.is_authenticated %}
            <button class="btn btn-outline-success btn-sm" data-save="{{ r }}">저장</button>
            {% endif %}
            <button class="btn btn-outline-secondary btn-sm" data-copy="{{ r }}">복사</button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
  for (const sel of document.querySelectorAll('select')) sel.classList.add('form-select');
  for (const inp of document.querySelectorAll('input')) if (!inp.classList.contains('form-check-input')) inp.classList.add('form-control');

  async function post(url, data){
    const csrftoken = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;
    const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken': csrftoken,'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams(data)});
    return res.json();
  }

  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const text = btn.getAttribute('data-copy');
      try { await navigator.clipboard.writeText(text); } catch(e) {}
      btn.textContent = '복사됨!';
      setTimeout(()=>btn.textContent='복사', 1000);
      {% if request.user.is_authenticated %}
      post('{% url 'nickgen:copy_ping' %}', {text});
      {% endif %}
    });
  });

  document.querySelectorAll('[data-save]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const text = btn.getAttribute('data-save');
      const form = new FormData(document.querySelector('form'));
      const payload = Object.fromEntries(form.entries());
      payload.text = text;
      const res = await post('{% url 'nickgen:save' %}', payload);
      btn.textContent = '저장됨';
      setTimeout(()=>btn.textContent='저장', 1000);
    });
  });
</script>
{% endblock %}
