<!-- templates/toolhub/tool_detail.html -->
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <div class="card shadow-sm">
    {% if tool.thumbnail %}
      <img src="{{ tool.thumbnail.url }}" class="card-img-top" style="height: 300px; object-fit: cover;">
    {% endif %}

    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="card-title m-0">{{ tool.name }}</h2>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'toolhub:toggle_tool_like' tool.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">
              â¤ï¸ {{ tool.total_likes }}
            </button>
          </form>

          <!-- ğŸ”¥ í•€ ë²„íŠ¼ -->
          <form method="post" action="{% url 'toolhub:pin_tool_to_profile' tool.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success btn-sm">ğŸ“Œ í•€</button>
          </form>
        
        {% else %}
          <span class="text-muted">â¤ï¸ {{ tool.total_likes }}</span>
        {% endif %}
      </div>

      <!-- íˆ´ ì„¤ëª…ì€ ì¢‹ì•„ìš” ë²„íŠ¼ ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ê²Œ -->
      <p class="card-text mt-3">{{ tool.description }}</p>

      {% if tool.link %}
        <a href="{% url 'toolhub:run_tool' tool.id %}" class="btn btn-primary mt-3" target="_blank">
          ğŸš€ íˆ´ ì‹¤í–‰í•˜ê¸°
        </a>
      {% endif %}

    </div>


    <ul class="list-group list-group-flush">
      <li class="list-group-item">ğŸ“… ë“±ë¡ì¼: {{ tool.created_at|date:"Y-m-d" }}</li>
      <li class="list-group-item">ğŸ‘ï¸ ê³µê°œ ì—¬ë¶€: {{ tool.get_visibility_display }}</li>
      <li class="list-group-item">ğŸ” ì ‘ê·¼ ê¶Œí•œ: {{ tool.get_access_level_display }}</li>
      <li class="list-group-item">
        ğŸ‘¤ ì•± ê´€ë¦¬ì:
        {% if tool.managers.exists %}
          {% for manager in tool.managers.all %}
            <a href="{% url 'carded:public_card_by_username' manager.username %}"
               class="badge bg-secondary text-decoration-none"
               title="{{ manager.email }}">
              {{ manager.username }}
            </a>{% if not forloop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          <a href="{% url 'carded:public_card_by_username' admin_user.username %}"
             class="badge bg-secondary text-decoration-none"
             title="{{ admin_user.email }}">
            {{ admin_user.username }}
          </a>
        {% endif %}
      </li>
      <li class="list-group-item">
        ğŸ›  ì•± ì œì‘ì:
        {% if tool.creators.exists %}
          {% for creator in tool.creators.all %}
            <a href="{% url 'carded:public_card_by_username' creator.username %}"
               class="badge bg-info text-decoration-none"
               title="{{ creator.email }}">
              {{ creator.username }}
            </a>{% if not forloop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          <span class="text-muted">ì •ë³´ ì—†ìŒ</span>
        {% endif %}
      </li>


    </ul>
  </div>
  <hr class="my-4">

  <div>
<!-- ì‚¬ìš©ì ë¦¬ë·° -->
<h5 class="mt-4">
  â­ ì‚¬ìš©ì ë¦¬ë·°
  {% if tool.comments.exists %}
    <span class="text-warning">
      (í‰ê· :
      {% for i in "12345" %}
        {% if forloop.counter <= average_rating_rounded %}
          â­
        {% else %}
          â˜†
        {% endif %}
      {% endfor %}
      / {{ average_rating|floatformat:1 }}ì )
    </span>
  {% endif %}
</h5>
{% for comment in tool.comments.all %}
<div class="border rounded p-3 mb-3">
<div class="d-flex justify-content-between align-items-center">
  <div>
    <strong>{{ comment.author }}</strong>
    {% for _ in "â­"|ljust:comment.stars %}
      <span class="text-warning">â­</span>
    {% endfor %}
  </div>

  <div class="text-end">
    <small class="text-muted">{{ comment.created_at|date:"Y.m.d H:i" }}</small>

    {% if user.is_authenticated %}
      <form method="post" action="{% url 'toolhub:toggle_comment_like' comment.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-primary">
          ğŸ‘ {{ comment.like_count }}
        </button>
      </form>
    {% else %}
      <span class="text-muted">ğŸ‘ {{ comment.like_count }}</span>
    {% endif %}
  </div>
</div>
  <p class="mt-2 mb-1">{{ comment.content }}</p>

    <!-- ëŒ€ëŒ“ê¸€ -->
    {% for reply in comment.replies.all %}
      <div class="ms-4 mt-2 ps-3 border-start border-2 border-secondary-subtle">
        <div class="d-flex justify-content-between">
          <div><strong>â†³ {{ reply.author }}</strong></div>
          <small class="text-muted">{{ reply.created_at|date:"Y.m.d H:i" }}</small>


        </div>
        <p class="mb-1">{{ reply.content }}</p>
      </div>
    {% endfor %}

    <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ -->
    {% if user.is_authenticated %}
      <form method="post" class="mt-2 ms-4">
        {% csrf_token %}
        {{ reply_form.content }}
        <input type="hidden" name="parent_id" value="{{ comment.id }}">
        <button name="reply_submit" class="btn btn-sm btn-outline-secondary mt-1">ë‹µê¸€</button>
      </form>
    {% endif %}
  </div>
{% empty %}
  <div class="text-muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
{% endfor %}


<!-- ëŒ“ê¸€ ì‘ì„± -->
{% if user.is_authenticated %}
  <h5 class="mt-4">âœï¸ ëŒ“ê¸€ ì‘ì„±</h5>
<!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
<form method="post">
  {% csrf_token %}
  {{ comment_form.as_p }}
  <button name="comment_submit" class="btn btn-primary">ëŒ“ê¸€ ë“±ë¡</button>
</form>
{% else %}
  <p class="text-muted">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{% url 'login' %}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
{% endif %}

  </div>

</div>
{% endblock %}
