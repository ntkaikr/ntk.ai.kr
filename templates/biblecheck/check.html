{% extends 'base.html' %}
{% load bible_extras %}

{% block content %}

<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link {% if request.resolver_match.url_name == 'check' %}active{% endif %}"
       href="{% url 'biblecheck:check' %}">âœ… ì²´í¬</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if request.resolver_match.url_name == 'history' %}active{% endif %}"
       href="{% url 'biblecheck:history' %}">ğŸ“œ ê¸°ë¡</a>
  </li>
</ul>

<h2 class="mb-4">ğŸ“– ë°”ì´ë¸” ì²´í¬</h2>

<form method="post" id="bible-form">
  {% csrf_token %}

  <!-- 1ï¸âƒ£ êµ¬ì•½/ì‹ ì•½ ì„ íƒ ì¹´ë“œ -->
  <div class="card mb-4">
    <div class="card-header fw-bold">1ï¸âƒ£ êµ¬ì•½ / ì‹ ì•½</div>
    <div class="card-body">
      {% for testament in structure %}
      <button type="button"
              onclick="submitWith('testament', '{{ testament }}')"
              class="btn {% if selected.testament == testament %}btn-primary{% else %}btn-outline-primary{% endif %} me-2">
        {{ testament }}
      </button>
      {% endfor %}
    </div>
  </div>

  {% if selected.testament %}
    <input type="hidden" name="testament" value="{{ selected.testament }}">

    <!-- 2ï¸âƒ£ ë¶„ë¥˜ ì„ íƒ ì¹´ë“œ -->
    <div class="card mb-4">
      <div class="card-header fw-bold">2ï¸âƒ£ ë¶„ë¥˜ ì„ íƒ</div>
      <div class="card-body">
        {% for section in sections %}
          <button type="button"
                  onclick="submitWith('section', '{{ section }}')"
                  class="btn {% if selected.section == section %}btn-success{% else %}btn-outline-success{% endif %} me-2 mb-2">
            {{ section }}
          </button>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if selected.testament and selected.section %}
    <input type="hidden" name="section" value="{{ selected.section }}">

    <!-- 3ï¸âƒ£ ì„±ê²½ ì„ íƒ ì¹´ë“œ -->
    <div class="card mb-4">
      <div class="card-header fw-bold">3ï¸âƒ£ ì„±ê²½ ì„ íƒ</div>
      <div class="card-body">
        {% for book, max_chapter in available_books.items %}
          <button type="button"
                  onclick="submitWith('book', '{{ book }}')"
                  class="btn {% if selected.book == book %}btn-warning{% else %}btn-outline-warning{% endif %} me-2 mb-2">
            {{ book }}
          </button>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if selected.book and max_chapter %}
    <input type="hidden" name="book" value="{{ selected.book }}">

    <!-- 4ï¸âƒ£ ì¥ ì„ íƒ ì¹´ë“œ -->
    <div class="card mb-4">
      <div class="card-header fw-bold">4ï¸âƒ£ ì¥ ì„ íƒ</div>
      <div class="card-body">
        {% for i in max_chapter|get_range %}
          <input type="checkbox" name="chapters" value="{{ i }}" id="ch{{ i }}"
                 class="btn-check"
                 {% if i|stringformat:"s" in selected_chapters or i|stringformat:"s" in already_checked %}checked{% endif %}>

          <label class="btn {% if i|stringformat:"s" in already_checked %}btn-success{% else %}btn-outline-secondary{% endif %}"
                 for="ch{{ i }}">
            {{ i }}
          </label>

        {% endfor %}
        <div class="mt-3">
          <button type="submit" class="btn btn-success">âœ… ì²´í¬í•˜ê¸°</button>
        </div>
      </div>
    </div>
  {% endif %}
</form>

<hr>

<!-- ğŸ“… ì˜¤ëŠ˜ì˜ ì²´í¬ ê¸°ë¡ -->
<h5 class="mt-5">ğŸ“… ì˜¤ëŠ˜ì˜ ì²´í¬ ê¸°ë¡</h5>
<ul class="list-group">
  {% for r in today_records %}
    <li class="list-group-item">{{ r.book }} {{ r.chapter }}ì¥</li>
  {% empty %}
    <li class="list-group-item text-muted">ì•„ì§ ì²´í¬ëœ ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>
  {% endfor %}
</ul>

<script>
function submitWith(name, value) {
  const form = document.getElementById('bible-form');

  form.querySelectorAll(`input[name="${name}"]`).forEach(el => el.remove());

  const resetMap = {
    'testament': ['section', 'book', 'chapters'],
    'section': ['book', 'chapters'],
    'book': ['chapters']
  };
  (resetMap[name] || []).forEach(reset => {
    form.querySelectorAll(`input[name="${reset}"]`).forEach(el => el.remove());
  });

  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = name;
  input.value = value;
  form.appendChild(input);

  form.submit();
}
</script>

{% endblock %}
